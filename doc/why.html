<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Why Visi?</title>
<!-- 2015-02-07 Sat 15:50 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="David Pollak" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Why Visi?</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Why Visi?</a>
<ul>
<li><a href="#sec-1-1">1.1. What is Visi?</a></li>
<li><a href="#sec-1-2">1.2. Core Concepts</a>
<ul>
<li><a href="#sec-1-2-1">1.2.1. But why functions?</a></li>
</ul>
</li>
<li><a href="#sec-1-3">1.3. Immutability</a></li>
<li><a href="#sec-1-4">1.4. Host Interoperability</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Why Visi?</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> What is Visi?</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Visi is a computer language that allows expression of big data jobs
in a syntax that's not frightening to people familiar with Excel formula functions.
There is more in Visi than there is in Excel formula functions,
but the "more" is adding to what's in Excel.
</p>

<p>
Let's start with a simple expression&#x2026; a thing that executes
code and returns a value:
</p>

<div class="org-src-container">

<pre class="src src-visi">1 <span style="color: #7CB8BB;">+</span> 1
</pre>
</div>

<p>
That's simple, the expression evaluates to <code>2</code>. Yay!
</p>

<p>
In Excel, each cell is a variable&#x2026; something that can contain
a value. In Excel, cells can be constants (values that do not change)
or formulas. If a cell contains a formula and that formula refers
to another cell, when the predicate cell's value changes, all
the dependent cells update their values.
</p>

<p>
In Visi, you name the placeholders for values.
So, to create a names:
</p>

<div class="org-src-container">

<pre class="src src-visi">x <span style="color: #7CB8BB;">=</span> 5

y <span style="color: #7CB8BB;">=</span> x <span style="color: #7CB8BB;">+</span> 5
</pre>
</div>


<p>
The above code created names "x" and "y". "x" is a constant
and "y" is dependent on "x".
</p>

<p>
In Visi and Excel, you can apply a function to a value:
</p>

<div class="org-src-container">

<pre class="src src-visi"><span style="color: #7F9F7F;">## Define a name that's associated with a String</span>
a1 <span style="color: #7CB8BB;">=</span> <span style="color: #CC9393;">"The Brown Cow"</span>

<span style="color: #7F9F7F;">## Calculate the length of the string</span>
length(a1)
</pre>
</div>

<pre class="example">
13
</pre>

<p>
Visi groups names of functions and other values (in Visi functions
are values) into different packages. Functions in packages can
be referenced with <code>package::name</code> like:
</p>

<div class="org-src-container">

<pre class="src src-visi" id="sin">Math:<span style="color: #BFEBBF;">:sin</span>(0.5)
</pre>
</div>

<p>
Computes to:
</p>

<pre class="example">
0.479425538604203
</pre>


<p>
In Excel, there are lots and lots of different functions. They are
all in the same group, although the user interface (Insert Function)
lets you pick
functions from categories like "Statistical" or "Financial".
</p>

<p>
In Visi, functions are grouped in separately named "packages" so that it's easier
to find a function you're looking for and sometimes, like in the
above example, we have to be explicit about which package the
function lives in. The <code>::</code> between <code>Math</code> and <code>sin</code> tells Visi
to look in the <code>Math</code> package for the function.
</p>

<p>
With Visi, you can use any Java package as part of your Visi notebook.
We will cover Java "Host Interoperability" and how to load Java JAR
files into your Visi notebook later in this document.
</p>

<p>
A declaration is the association of a value with a name
such that the named declaration can be accessed
by other parts of your notebook. For example:
</p>

<div class="org-src-container">

<pre class="src src-visi" id="cos_third_pi">Math:<span style="color: #BFEBBF;">:cos</span>(Math:<span style="color: #BFEBBF;">:PI</span> / 3) <span style="color: #7F9F7F;">## expression</span>

cos_third_pi <span style="color: #7CB8BB;">=</span> Math:<span style="color: #BFEBBF;">:cos</span>(Math:<span style="color: #BFEBBF;">:PI</span> / 3) <span style="color: #7F9F7F;">## declaration</span>

cos_third_pi <span style="color: #7F9F7F;">## referencing the name</span>
</pre>
</div>


<p>
In Visi, you can create your own functions. So you can use
the same logic in many places without having to copy/paste that logic
over and over:
</p>

<div class="org-src-container">

<pre class="src src-visi">calc_tax(income) <span style="color: #7CB8BB;">=</span> income * <span style="color: #F0DFAF; font-weight: bold;">if</span>(income <span style="color: #7CB8BB;">&gt;</span> 5,000, 40%, 20%)
</pre>
</div>


<p>
The above function computes the tax amount depending on the income level.
</p>

<p>
And functions can call other functions:
</p>

<div class="org-src-container">

<pre class="src src-visi">tax_rate(income) <span style="color: #7CB8BB;">=</span> <span style="color: #F0DFAF; font-weight: bold;">if</span>(income <span style="color: #7CB8BB;">&gt;</span> 5,000, 40%, 20%)

calc_tax(income) <span style="color: #7CB8BB;">=</span> income * tax_rate(income)
</pre>
</div>

<p>
Visi syntax can span multiple lines and if/then/else can be
a formula and it has its own syntax that might be easier to read:
</p>

<div class="org-src-container">

<pre class="src src-visi">tax_rate(income) <span style="color: #7CB8BB;">=</span>
  <span style="color: #F0DFAF; font-weight: bold;">if</span> income <span style="color: #7CB8BB;">&gt;</span> 5,000 <span style="color: #F0DFAF; font-weight: bold;">then</span>
    40%
  <span style="color: #F0DFAF; font-weight: bold;">else</span>
    20%

calc_tax(income) <span style="color: #7CB8BB;">=</span> income * tax_rate(income)
</pre>
</div>

<p>
And Visi code can contain comments so that you and others who
read the code can understand what's going on:
</p>

<div class="org-src-container">

<pre class="src src-visi">tax_rate(income) <span style="color: #7CB8BB;">=</span>
  <span style="color: #F0DFAF; font-weight: bold;">if</span> income <span style="color: #7CB8BB;">&gt;</span> 5,000 <span style="color: #F0DFAF; font-weight: bold;">then</span>
    40% <span style="color: #7F9F7F;">## for high incomes</span>
  <span style="color: #F0DFAF; font-weight: bold;">else</span>
    20% <span style="color: #7F9F7F;">## for lower incomes</span>

calc_tax(income) <span style="color: #7CB8BB;">=</span> income * tax_rate(income)
</pre>
</div>

<p>
To summarize, Visi syntax is a lot like Excel syntax, but
there are extensions to what you are familiar with in Excel to
make writing more complex Visi notebooks easier.
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Core Concepts</h3>
<div class="outline-text-3" id="text-1-2">
<p>
In Visi, there are three constructs: expressions, declarations,
and housekeeping.
</p>

<p>
An expression is a value that's computed.
Expressions can evaluate to either values or functions. Or
more precisely, functions are values just like numbers and
strings and collections.
</p>

<p>
What's a collection? It's a group of other values. For example:
</p>

<div class="org-src-container">

<pre class="src src-visi">[1, 2, 3, 4]
</pre>
</div>

<p>
Is a collection of numbers. The specific collection type is
called a <code>Vector</code>. It's a 1 dimensional ordered array of values.
Ordered means that the Vector retains the elements in the
order that it was originally created.
</p>

<p>
Visi also supports sets. Sets are unordered collections
that contain unique values. So:
</p>

<div class="org-src-container">

<pre class="src src-visi" id="a-set">#{<span style="color: #CC9393;">"foo"</span>, <span style="color: #CC9393;">"bar"</span>, <span style="color: #CC9393;">"baz"</span>, <span style="color: #CC9393;">"foo"</span>, <span style="color: #CC9393;">"dog"</span>, <span style="color: #CC9393;">"dog"</span>, <span style="color: #CC9393;">"baz"</span>}
</pre>
</div>

<p>
Only contains 4 elements:
</p>

<pre class="example">
#{"foo", "bar", "dog", "baz"}
</pre>

<p>
Another collection is an association. An association is collection of
unique keys and values. Both the keys and values
can be any Visi value. Let's create an association of people and
ages:
</p>

<div class="org-src-container">

<pre class="src src-visi">{<span style="color: #CC9393;">"David"</span> 51, <span style="color: #CC9393;">"Archer"</span> 11, <span style="color: #CC9393;">"Tessa"</span> 2}
</pre>
</div>

<p>
Note that like sets, the keys in an association are unordered.
</p>

<p>
If you are familiar with <a href="http://en.wikipedia.org/wiki/JavaScript">JavaScript</a>,
associations in Visi are like Objects in JavaScript&#x2026; collections of
key/value pairs.
</p>

<p>
Visi also has a <code>keyword</code> type. Keywords are handy for
giving a common/shared name to a value in an association. For example:
</p>

<div class="org-src-container">

<pre class="src src-visi">[{<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"David"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Human"</span>, age: 51},
 {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Archer"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Dog"</span>, age: 11},
 {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Tessa"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Cat"</span>, age: 2}]
</pre>
</div>

<p>
If you're familiar with JavaScript or <a href="http://json.org">JSON</a>,
the Visi syntax for defining an association looks just like JSON.
Familiarity is good.
</p>

<p>
In Visi, functions are values just like strings and numbers and
keywords.
The declaration of a function is just fancy syntax, both of
the following declarations mean the same thing (don't worry about the
function expression syntax for the moment):
</p>

<div class="org-src-container">

<pre class="src src-visi" id="plus_one"><span style="color: #7F9F7F;">## assign a function to a name</span>
plus_one <span style="color: #7CB8BB;">=</span> x =&gt; x <span style="color: #7CB8BB;">+</span> 1

another_plus_one(x) <span style="color: #7CB8BB;">=</span> x <span style="color: #7CB8BB;">+</span> 1

z <span style="color: #7CB8BB;">=</span> 99

plus_one(z) <span style="color: #7CB8BB;">==</span> another_plus_one(z)
</pre>
</div>

<p>
Are the two functions the same?
</p>

<pre class="example">
true
</pre>

<p>
The first example, assigns the expression <code>x =&gt; x + 1</code> to <code>plus_one</code>. That
expression evaluates to a function. The second example does the same thing
with different syntax. The latter is "syntactic sugar" for the former.
</p>

<p>
You may be asking, "why do you have more than one way to say the same thing?"
Good question. Visi creates syntactic sugar to give you a more concise
or more natural way of expressing the same code. In different contexts,
the different syntax may seem more natural. For example, the first
declaration looks kind of odd where the second looks like the way we
learned functions in math class. We will get to some examples of passing
functions as parameters in a little while.
</p>

<p>
In Visi, top level names (those names defined outside
another assignment) can be accessed by any expression
in a Visi notebook, just like values in cells in Excel.
</p>
</div>

<div id="outline-container-sec-1-2-1" class="outline-4">
<h4 id="sec-1-2-1"><span class="section-number-4">1.2.1</span> But why functions?</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
Functions take parameters and perform operations
on the parameters and return a value.
</p>

<p>
You're familiar with functions in Excel. Functions
are built into Excel, can be added via add-ins, and
via VisualBasic.
</p>

<p>
In Visi, there are plenty of sources of functions.
Some are built in, some can be packaged as JAR files
and downloaded, and some can be defined in your notebook.
</p>

<p>
Functions in Visi can be applied to every element of
a collection. This is called a <code>map</code> operation.
Hey&#x2026; that's part of MapReduce&#x2026; yes!
</p>

<p>
We're going to build a map/reduce job and see
how it works locally. The cool thing about Visi
is that you can explore a job locally and then
deploy the same job to a cluster of computers
running <a href="https://storm.apache.org/">Apache Storm</a>,
<a href="https://spark.apache.org/">Apache Spark</a>,
<a href="http://tez.apache.org/">Apache Tez</a>, and other
cluster frameworks. This is because the way you
describe a pipeline of operations in Visi can be
converted into a pipeline in many different
frameworks.
</p>

<p>
Let's get started.
</p>

<div class="org-src-container">

<pre class="src src-visi" id="first-example"><span style="color: #7F9F7F;">## Who lives with us?</span>
source residents <span style="color: #7CB8BB;">=</span>
 [{<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"David"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Human"</span>, age: 51},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Archer"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Dog"</span>, age: 11},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Tessa"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Cat"</span>, age: 3}]

get_age(r) <span style="color: #7CB8BB;">=</span> <span style="color: #93E0E3;">get</span>(r, age:)

<span style="color: #7F9F7F;">## Get the ages</span>
ages <span style="color: #7CB8BB;">=</span> <span style="color: #93E0E3;">map</span>(get_age, residents)

sink the_ages <span style="color: #7CB8BB;">=</span> ages
</pre>
</div>

<p>
And we get:
</p>

<pre class="example">
[51, 11, 3]
</pre>

<p>
Note that we define the <code>source</code> and <code>sink</code> for the calculation.
A <code>source</code> is the name of a place that the information comes from.
When you're using your Visi notebook in interactive mode, you
can define a sample of data for a <code>source</code>. But when you deploy
the Visi notebook to your big data cluster, you can associate
sources and sinks with platform dependent data&#x2026; for example files
on your HDFS cluster. This mechanism let's your interactively
play with your calculations, get them right, and then
deploy <b>the same</b> Visi notebook to your cluster.
</p>

<p>
Okay&#x2026; back to creating a map/reduce job.
</p>

<p>
We've seen that we can <code>map</code> over data to get the <code>age</code> of each
record, the syntax is a little verbose. Let's build an inline
function that does the same thing:
</p>

<div class="org-src-container">

<pre class="src src-visi" id="example2"><span style="color: #7F9F7F;">## Who lives with us?</span>
source residents <span style="color: #7CB8BB;">=</span>
 [{<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"David"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Human"</span>, age: 51},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Archer"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Dog"</span>, age: 11},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Tessa"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Cat"</span>, age: 3}]

<span style="color: #7F9F7F;">## Get the ages</span>
ages <span style="color: #7CB8BB;">=</span> <span style="color: #93E0E3;">map</span>(r =&gt; <span style="color: #93E0E3;">get</span>(r, age:), residents)

sink the_ages <span style="color: #7CB8BB;">=</span> ages
</pre>
</div>

<pre class="example">
[51, 11, 3]
</pre>

<p>
A little better, but still more verbose than we'd
like. It turns out that a <code>keyword</code> is also a function, so
we can shorten the function to <code>age:</code> like so:
</p>

<div class="org-src-container">

<pre class="src src-visi" id="example3"><span style="color: #7F9F7F;">## Who lives with us?</span>
source residents <span style="color: #7CB8BB;">=</span>
 [{<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"David"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Human"</span>, age: 51},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Archer"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Dog"</span>, age: 11},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Tessa"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Cat"</span>, age: 3}]

<span style="color: #7F9F7F;">## Get the ages</span>
ages <span style="color: #7CB8BB;">=</span> <span style="color: #93E0E3;">map</span>(age:, residents)

sink the_ages <span style="color: #7CB8BB;">=</span> ages
</pre>
</div>

<pre class="example">
[51, 11, 3]
</pre>

<p>
Now, let's compute the sum of ages using the <code>reduce</code> function.
Yep, we're going to map <b>and</b> reduce&#x2026; woo hoo:
</p>

<div class="org-src-container">

<pre class="src src-visi" id="example4"><span style="color: #7F9F7F;">## Who lives with us?</span>
source residents <span style="color: #7CB8BB;">=</span>
 [{<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"David"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Human"</span>, age: 51},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Archer"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Dog"</span>, age: 11},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Tessa"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Cat"</span>, age: 3}]

<span style="color: #7F9F7F;">## Get the ages</span>
ages <span style="color: #7CB8BB;">=</span> <span style="color: #93E0E3;">map</span>(age:, residents)

age_sum <span style="color: #7CB8BB;">=</span> <span style="color: #93E0E3;">reduce</span>((<span style="color: #7CB8BB;">+</span>), ages)

sink sum <span style="color: #7CB8BB;">=</span> age_sum
</pre>
</div>

<pre class="example">
65
</pre>

<p>
The <code>reduce((+ ), ages)</code> expression adds up
each element in the ages collection. The <code>(+)</code>
expression creates a function that takes two
parameters and adds them up. The <code>(operator)</code>
syntax is another way of creating a function.
</p>

<p>
And we can compute the average age:
</p>

<div class="org-src-container">

<pre class="src src-visi" id="example5"><span style="color: #7F9F7F;">## Who lives with us?</span>
source residents <span style="color: #7CB8BB;">=</span>
 [{<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"David"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Human"</span>, age: 51},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Archer"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Dog"</span>, age: 11},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Tessa"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Cat"</span>, age: 3}]

<span style="color: #7F9F7F;">## Get the ages</span>
ages <span style="color: #7CB8BB;">=</span> <span style="color: #93E0E3;">map</span>(age:, residents)

age_sum <span style="color: #7CB8BB;">=</span> <span style="color: #93E0E3;">reduce</span>((<span style="color: #7CB8BB;">+</span>), ages)

sink sum <span style="color: #7CB8BB;">=</span> age_sum / <span style="color: #93E0E3;">count</span>(residents)
</pre>
</div>

<pre class="example">
65/3
</pre>

<p>
Note that Visi can express rational numbers&#x2026; numbers
that are ratios of each other. This means that Visi
avoids some floating point related issues.
</p>

<p>
So, yay&#x2026; we have created our first map/reduce job, except for
one thing&#x2026; the <code>count</code> function doesn't work so well over cluster,
so we'll have to aggregate the count as part of the reduce phase:
</p>

<div class="org-src-container">

<pre class="src src-visi" id="example6"><span style="color: #7F9F7F;">## Who lives with us?</span>
source residents <span style="color: #7CB8BB;">=</span>
 [{<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"David"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Human"</span>, age: 51},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Archer"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Dog"</span>, age: 11},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Tessa"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Cat"</span>, age: 3}]

<span style="color: #7F9F7F;">## Get the ages</span>
ages <span style="color: #7CB8BB;">=</span> <span style="color: #93E0E3;">map</span>(# {<span style="color: #93E0E3;">count</span>: 1, age: it.age}, residents)

age_sum <span style="color: #7CB8BB;">=</span> <span style="color: #93E0E3;">reduce</span>(| merge_with((<span style="color: #7CB8BB;">+</span>)), ages)

sink sum <span style="color: #7CB8BB;">=</span> age_sum.age / age_sum.<span style="color: #93E0E3;">count</span>
</pre>
</div>

<pre class="example">
65/3
</pre>

<p>
We've done a couple of things above&#x2026; the first is
we've introduced another mechanism for defining a
function. Putting a <code>#</code> and then a space before an expression
turns the expression into a function that takes one parameter
and that parameter is named <code>it</code> (a little homage to <a href="http://groovy.codehaus.org/">Groovy</a>).
</p>

<p>
The next thing we've introduced is another mechanism for getting
a value from an association. The <code>it.age</code> syntax is JavaScript-like
syntax that does the same thing as <code>get(age: it)</code>.
</p>

<p>
In the <code>age_sum</code> expression, we <code>reduce</code> over the <code>ages</code>
collection. But instead of just adding the elements, we must
merge the elements because they are associations. <code>merge_with</code>
takes a function and two associations and merges them. Each
for any common key in each association, the function is called
to combine the values at each shared key.
</p>

<p>
The <code>|</code> followed by a space is yet another syntax for creating
functions. In this case, they are partially applied functions.
A partially applied function has some parameters filled in and when
it's called, the balance of the parameters are filled in. The following
function declarations each do the same thing:
</p>

<ul class="org-ul">
<li>(x,y) =&gt; merge_ with((q, r) =&gt; q + r, x, y)
</li>
<li><code>#2 merge_with((+ ), it1, it2)</code>
</li>
<li><code>| merge_with((+))</code>
</li>
</ul>

<p>
So, we've created a series of steps to run a map/reduce
job in Visi. But Visi has some syntax that helps to make
map/reduce jobs easier to write and more obvious.
Visi allows you to write "transformation pipes" that
allow you to express the transformations in a single pipeline.
</p>

<div class="org-src-container">

<pre class="src src-visi" id="example7"><span style="color: #7F9F7F;">## Who lives with us?</span>
source residents <span style="color: #7CB8BB;">=</span>
 [{<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"David"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Human"</span>, age: 51},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Archer"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Dog"</span>, age: 11},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Tessa"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Cat"</span>, age: 3}]

<span style="color: #7F9F7F;">## Run the whole job</span>
job <span style="color: #7CB8BB;">=</span> residents <span style="color: #7CB8BB;">|&gt;</span> <span style="color: #93E0E3;">map</span> # {<span style="color: #93E0E3;">count</span>: 1,
                          age: it.age}
                <span style="color: #7CB8BB;">|&gt;</span> <span style="color: #93E0E3;">reduce</span> | merge_with((<span style="color: #7CB8BB;">+</span>))

sink average_age <span style="color: #7CB8BB;">=</span> job.age / job.<span style="color: #93E0E3;">count</span>
</pre>
</div>

<pre class="example">
65/3
</pre>

<p>
Finally, Visi has helper functions that make your life
a lot easier&#x2026; like creating count associations based on
a key or merge/summing:
</p>

<div class="org-src-container">

<pre class="src src-visi" id="example8"><span style="color: #7F9F7F;">## Who lives with us?</span>
source residents <span style="color: #7CB8BB;">=</span>
 [{<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"David"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Human"</span>, age: 51},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Archer"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Dog"</span>, age: 11},
  {<span style="color: #93E0E3;">name</span>: <span style="color: #CC9393;">"Tessa"</span>, <span style="color: #93E0E3;">type</span>: <span style="color: #CC9393;">"Cat"</span>, age: 3}]

<span style="color: #7F9F7F;">## Run the whole job</span>
job <span style="color: #7CB8BB;">=</span> residents <span style="color: #7CB8BB;">|&gt;</span> <span style="color: #93E0E3;">map</span> count_for(age:)
                <span style="color: #7CB8BB;">|&gt;</span> <span style="color: #93E0E3;">reduce</span> merge_sum

sink average_age <span style="color: #7CB8BB;">=</span> job.age / job.<span style="color: #93E0E3;">count</span>
</pre>
</div>

<pre class="example">
65/3
</pre>

<p>
The <code>count_for</code> function returns a function that builds
a count association based on the key. The <code>merge_sum</code> function
is the same as <code>merge_with((+), x, y)</code>.
</p>

<p>
So, you've built your first map/reduce job in Visi and it's
pretty simple.
</p>

<p>
Next, we're going to go through some Visi pieces/parts.
</p>

<p>
You can also declare names that are only visible to expressions
that come after the declaration in the expression. This allows
you to compute an expression and use the result in many
places within a larger expression. For example:
</p>

<div class="org-src-container">

<pre class="src src-visi">test_income(income) <span style="color: #7CB8BB;">=</span>
  mag <span style="color: #7CB8BB;">=</span> Math:<span style="color: #BFEBBF;">:log</span>10(income) <span style="color: #7F9F7F;">## the magnitude of the income</span>
  <span style="color: #F0DFAF; font-weight: bold;">if</span> mag <span style="color: #7CB8BB;">&lt;</span> 3 <span style="color: #F0DFAF; font-weight: bold;">then</span> <span style="color: #CC9393;">"low"</span>
  <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> mag <span style="color: #7CB8BB;">&lt;</span> 5 <span style="color: #F0DFAF; font-weight: bold;">then</span> <span style="color: #CC9393;">"med"</span>
  <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #CC9393;">"high"</span>

<span style="color: #93E0E3;">map</span>(x =&gt; <span style="color: #93E0E3;">str</span>(x, <span style="color: #CC9393;">": "</span>, test_income(x)),
    [300, 50,000, 250,000])
</pre>
</div>

<pre class="example">
["300: low", "50000: med", "250000: high"]
</pre>

<p>
We compute the value of <code>mag</code> and then reference that
name in the <code>if/then/else</code> expression.
</p>

<p>
Also, note that the comma can be used as a number place separator. Put
spaces after commas to help the Visi parser distinguish between
<code>[100,240]</code> and <code>[100, 240]</code>.
</p>

<p>
Visi supports multiline, complex strings. A normal String is enclosed
in double quotes: ="I am a String"=. But sometimes, you might
want to have a double-quote in a string&#x2026; for example if you paste
a bunch of data you got off the Internet, you don't want to
have to escape the Strings. Visi has a handy, string literal.
Any sequence of characters that starts with <code>#</code> and two or more
single quote ('), double quote (") or carrot (^) and ends with
the same number/type of delimiter will be treated as a single string.
This is especially useful for putting CSV data into your Visi code:
</p>

<div class="org-src-container">

<pre class="src src-visi">[
 #'''Year,Make,Model,Description,Price''',
 #'''1997,Ford,E350,<span style="color: #CC9393;">"ac, abs, moon"</span>,3000.00''',
 #'''1999,Chevy,<span style="color: #CC9393;">"Venture ""Extended Edition"""</span>,<span style="color: #CC9393;">""</span>,4900.00''',
 #'''1999,Chevy,<span style="color: #CC9393;">"Venture ""Extended Edition, Very Large"""</span>,,5000.00''',
 #'''1996,Jeep,Grand Cherokee,<span style="color: #CC9393;">"MUST SELL!</span>
<span style="color: #CC9393;"> air, moon roof, loaded"</span>,4799.00'''
 ]
</pre>
</div>

<pre class="example">
["Year,Make,Model,Description,Price", "1997,Ford,E350,\"ac, abs, moon\",3000.00", "1999,Chevy,\"Venture \"\"Extended Edition\"\"\",\"\",4900.00", "1999,Chevy,\"Venture \"\"Extended Edition, Very Large\"\"\",,5000.00", "1996,Jeep,Grand Cherokee,\"MUST SELL!\n air, moon roof, loaded\",4799.00"]
</pre>

<p>
Now that we've got the pieces out to the way, let's do a word count example in Visi:
</p>

<div class="org-src-container">

<pre class="src src-visi">source king_james <span style="color: #7CB8BB;">=</span>
 [
   #'''Gen|1|1| In the beginning God created the heaven <span style="color: #93E0E3;">and</span> the earth.~''',
   #'''Gen|1|2| And the earth was without form, <span style="color: #93E0E3;">and</span> void; <span style="color: #93E0E3;">and</span> darkness was upon the face of the deep. And the Spirit of God moved upon the face of the waters.~''',
   #'''Gen|1|3| And God said, Let there be light: <span style="color: #93E0E3;">and</span> there was light.~''',
   #'''Gen|1|4| And God saw the light, that it was good: <span style="color: #93E0E3;">and</span> God divided the light from the darkness.~''',
   #'''Gen|1|5| And God called the light Day, <span style="color: #93E0E3;">and</span> the darkness he called Night. And the evening <span style="color: #93E0E3;">and</span> the morning were the <span style="color: #93E0E3;">first</span> day.~''',
   #'''Gen|1|6| And God said, Let there be a firmament in the midst of the waters, <span style="color: #93E0E3;">and</span> <span style="color: #93E0E3;">let</span> it divide the waters from the waters.~''',
   #'''Gen|1|7| And God made the firmament, <span style="color: #93E0E3;">and</span> divided the waters which were under the firmament from the waters which were above the firmament: <span style="color: #93E0E3;">and</span> it was so.~''',
   #'''Gen|1|8| And God called the firmament Heaven. And the evening <span style="color: #93E0E3;">and</span> the morning were the <span style="color: #93E0E3;">second</span> day.~''',
   #'''Gen|1|9| And God said, Let the waters under the heaven be gathered together unto one place, <span style="color: #93E0E3;">and</span> <span style="color: #93E0E3;">let</span> the dry land appear: <span style="color: #93E0E3;">and</span> it was so.~''',
   #'''Gen|1|10| And God called the dry land Earth; <span style="color: #93E0E3;">and</span> the gathering together of the waters called he Seas: <span style="color: #93E0E3;">and</span> God saw that it was good.~''',
   #'''Gen|1|11| And God said, Let the earth bring forth grass, the herb yielding seed, <span style="color: #93E0E3;">and</span> the fruit tree yielding fruit after his kind, whose seed is in itself, upon the earth: <span style="color: #93E0E3;">and</span> it was so.~''',
   #'''Gen|1|12| And the earth brought forth grass, <span style="color: #93E0E3;">and</span> herb yielding seed after his kind, <span style="color: #93E0E3;">and</span> the tree yielding fruit, whose seed was in itself, after his kind: <span style="color: #93E0E3;">and</span> God saw that it was good.~''',
   #'''Gen|1|13| And the evening <span style="color: #93E0E3;">and</span> the morning were the third day.~''',
   #'''Gen|1|14| And God said, Let there be lights in the firmament of the heaven to divide the day from the night; <span style="color: #93E0E3;">and</span> <span style="color: #93E0E3;">let</span> them be <span style="color: #F0DFAF; font-weight: bold;">for</span> signs, <span style="color: #93E0E3;">and</span> <span style="color: #F0DFAF; font-weight: bold;">for</span> seasons, <span style="color: #93E0E3;">and</span> <span style="color: #F0DFAF; font-weight: bold;">for</span> days, <span style="color: #93E0E3;">and</span> years:~''',
   #'''Gen|1|15| And <span style="color: #93E0E3;">let</span> them be <span style="color: #F0DFAF; font-weight: bold;">for</span> lights in the firmament of the heaven to give light upon the earth: <span style="color: #93E0E3;">and</span> it was so.~''',
   #'''Gen|1|16| And God made two great lights; the greater light to rule the day, <span style="color: #93E0E3;">and</span> the lesser light to rule the night: he made the stars also.~''',
   #'''Gen|1|17| And God <span style="color: #93E0E3;">set</span> them in the firmament of the heaven to give light upon the earth,~''',
   #'''Gen|1|18| And to rule over the day <span style="color: #93E0E3;">and</span> over the night, <span style="color: #93E0E3;">and</span> to divide the light from the darkness: <span style="color: #93E0E3;">and</span> God saw that it was good.~''',
   #'''Gen|1|19| And the evening <span style="color: #93E0E3;">and</span> the morning were the fourth day.~''',
   #'''Gen|1|20| And God said, Let the waters bring forth abundantly the moving creature that hath life, <span style="color: #93E0E3;">and</span> fowl that may fly above the earth in the open firmament of heaven.~''',
   #'''Gen|1|21| And God created great whales, <span style="color: #93E0E3;">and</span> every living creature that moveth, which the waters brought forth abundantly, after their kind, <span style="color: #93E0E3;">and</span> every winged fowl after his kind: <span style="color: #93E0E3;">and</span> God saw that it was good.~''',
   #'''Gen|1|22| And God blessed them, saying, Be fruitful, <span style="color: #93E0E3;">and</span> multiply, <span style="color: #93E0E3;">and</span> fill the waters in the seas, <span style="color: #93E0E3;">and</span> <span style="color: #93E0E3;">let</span> fowl multiply in the earth.~''',
   #'''Gen|1|23| And the evening <span style="color: #93E0E3;">and</span> the morning were the fifth day.~''',
 ]

to_remove <span style="color: #7CB8BB;">=</span> #{<span style="color: #CC9393;">"the"</span>, <span style="color: #CC9393;">"and"</span>}

counted_words <span style="color: #7CB8BB;">=</span> king_james
  <span style="color: #7CB8BB;">|&gt;</span> <span style="color: #93E0E3;">map</span> # re_replace(it, #//[^a-zA-Z]<span style="color: #7CB8BB;">+</span>//, <span style="color: #CC9393;">" "</span>) <span style="color: #7F9F7F;">## strip non-words</span>
  <span style="color: #7CB8BB;">|&gt;</span> <span style="color: #93E0E3;">map</span> # toLowerCase(it) <span style="color: #7F9F7F;">## convert to lower case</span>
  <span style="color: #7CB8BB;">|&gt;</span> flatmap | re_seq(#//\w+//) <span style="color: #7F9F7F;">## split by word</span>
  <span style="color: #7CB8BB;">|&gt;</span> <span style="color: #93E0E3;">filter</span> (<span style="color: #7CB8BB;">|&gt;</span> #{<span style="color: #CC9393;">"the"</span>, <span style="color: #CC9393;">"and"</span>, <span style="color: #CC9393;">"gen"</span>} <span style="color: #7CB8BB;">|&gt;</span> <span style="color: #93E0E3;">not</span>) <span style="color: #5F7F5F;">##</span> <span style="color: #93E0E3;">remove</span> <span style="color: #CC9393;">"the"</span>, <span style="color: #CC9393;">"gen"</span>, <span style="color: #93E0E3;">and</span> <span style="color: #CC9393;">"and"</span>
  <span style="color: #7CB8BB;">|&gt;</span> <span style="color: #93E0E3;">map</span> # {it 1} <span style="color: #7F9F7F;">## create association between word and number 1</span>
  <span style="color: #7CB8BB;">|&gt;</span> <span style="color: #93E0E3;">reduce</span> merge_sum <span style="color: #7F9F7F;">## count by word</span>
  <span style="color: #7CB8BB;">|&gt;</span> <span style="color: #93E0E3;">sort</span> <span style="color: #93E0E3;">second</span>, descending <span style="color: #7F9F7F;">## sort by count (the second part of the word/count pair)</span>

sink words <span style="color: #7CB8BB;">=</span> counted_words
</pre>
</div>

<pre class="example">
[["god", 22], ["was", 13], ["waters", 11], ["let", 11], ["in", 10], ["it", 10], ["earth", 10], ["light", 10], ["day", 9], ["of", 9]]
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Immutability</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Like Excel, Visi doesn't let you change a value once it's computed.
This is strange for users of Java and JavaScript. In addition to Visi's
syntax which is simple and free from complex stuff from Java like <code>void</code>
and <code>class</code> and such, Visi's types can be converted into a form that can
be distributed across a cluster of computes. Visi data types can be
turned into bytes that get turned back into the same data types on
the other side of the network.
</p>

<p>
Between serialization and immutability, Visi provides tools that make
writing distributed computing jobs simple.
</p>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> Host Interoperability</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Visi sits on top of two host systems. All Visi code is compiled to
(well, more technically, transliterated to) <a href="http://clojure.org">Clojure</a>. Then
the Clojure code is compiled into <a href="http://en.wikipedia.org/wiki/Java_virtual_machine">Java Virtual Machine</a>
byte-code. This means that Visi code works with any Clojure and
Java library and Visi code can be used in and called by
any JVM-based Big Data platform.
Being able to work with any Java and Clojure library
means that you have a wealth of libraries to use. But how do you
use these libraries in Visi?
</p>

<p>
First, let's deal with method calls. Java objects all have methods.
Rather than using functions like Visi and Clojure, all the actions
that can be done to a particular Object is by invoking a method
on an Object.
</p>

<p>
Visi mostly makes method invocation seamless. If there's no
function matching the function name, then Visi invokes
that named method on the object. For example:
</p>

<div class="org-src-container">

<pre class="src src-visi">toString([1, 2, 3])
</pre>
</div>

<pre class="example">
"[1 2 3]"
</pre>

<p>
Boom, the <code>toString</code> method is invoked on the object. In this case,
the Vector in Visi is actually represented by a Clojure Vector
and we've called the <code>.toString</code> method on it.
</p>

<p>
You can be explicit about calling a method if there's ambiguity
about a name being in scope. By prefixing a function name with <code>$.</code>,
Visi forces the method invocation:
</p>

<div class="org-src-container">

<pre class="src src-visi">$.toString($.size([1, 2, 3]))
</pre>
</div>

<pre class="example">
"3"
</pre>

<p>
Visi also supports Java/JavaScript style method invocation:
</p>

<div class="org-src-container">

<pre class="src src-visi">x <span style="color: #7CB8BB;">=</span> [1, 2, 3]
  x.size().toString()
</pre>
</div>

<pre class="example">
"3"
</pre>

<p>
And if you want to force a method invocation rather than
a function call (if there is a function in scope with the same
name as the method you want to call):
</p>

<div class="org-src-container">

<pre class="src src-visi">x <span style="color: #7CB8BB;">=</span> [1, 2, 3]
  x$.size()$.toString()
</pre>
</div>

<pre class="example">
"3"
</pre>

<p>
Why the different ways to do the same thing?
Mostly because there will be times when it's
cleaner/easier to read/update when you use
one style or the other.
</p>

<p>
Mostly with the <code>$package</code> declaration. Note the <code>$</code>. This means
that you're explicitly using some form of host interoperability.
</p>

<p>
Using <code>$package</code>, you declare the name of the package your code
runs in (usually, <code>visi.notebook</code>) and you load any packages
you might need off the Internet, for example, the Apache
Commons CSV package.
</p>

<div class="org-src-container">

<pre class="src src-visi">$package(visi.notebook,
  <span style="color: #93E0E3;">load</span>([org.apache.commons/commons-csv, <span style="color: #CC9393;">"1.0"</span>]),
  <span style="color: #93E0E3;">import</span>(org.apache.commons.csv.CSVParser,
         org.apache.commons.csv.CSVFormat))

(CSVParser:<span style="color: #BFEBBF;">:parse</span>(#'''1,2,<span style="color: #CC9393;">"hello, moose"</span>,33,<span style="color: #CC9393;">"thing"</span>''', CSVFormat:<span style="color: #BFEBBF;">:DEFAULT</span>))
  <span style="color: #7CB8BB;">|&gt;</span> <span style="color: #93E0E3;">first</span> <span style="color: #7F9F7F;">## get the first element</span>
  <span style="color: #7CB8BB;">|&gt;</span> <span style="color: #93E0E3;">seq</span> <span style="color: #7F9F7F;">## turn it into a sequence</span>
</pre>
</div>

<pre class="example">
["1", "2", "hello, moose", "33", "thing"]
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: David Pollak</p>
<p class="date">Created: 2015-02-07 Sat 15:50</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
